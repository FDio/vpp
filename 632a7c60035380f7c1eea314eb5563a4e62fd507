{
  "comments": [
    {
      "key": {
        "uuid": "27238594_cbd919c3",
        "filename": "src/vnet/ipsec/ipsec_spd_policy.h",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 2465
      },
      "writtenOn": "2022-05-16T17:14:01Z",
      "side": 1,
      "message": "What\u0027s the logic for the bihash sizing here?\n\nSince we\u0027re hashing policies, I would have thought the maximum it would need to be is number of policies/BIHASH_KVP_PER_PAGE[1] which is 4.\n\n1: https://fdio-vpp.readthedocs.io/en/latest/gettingstarted/developers/bihash.html#initializing-a-bihash-table",
      "revId": "632a7c60035380f7c1eea314eb5563a4e62fd507",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "93821da0_6825519f",
        "filename": "src/vnet/ipsec/ipsec_spd_policy.h",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 1854
      },
      "writtenOn": "2022-05-18T09:30:02Z",
      "side": 1,
      "message": "I did performance unit tests with values 2^16 and 2^20 and I saw the difference that\u0027s why I kept 2^20. But thanks for suggestion and reasoning. I will change that number to 2^18.",
      "parentUuid": "27238594_cbd919c3",
      "revId": "632a7c60035380f7c1eea314eb5563a4e62fd507",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4c6e13b2_19554c57",
        "filename": "src/vnet/ipsec/ipsec_spd_policy.h",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 2465
      },
      "writtenOn": "2022-05-19T07:46:02Z",
      "side": 1,
      "message": "2^18 is still 262144, which would mean we\u0027re expecting 1 million entries in fast path? I think that is unlikely for most use cases, is it not? We shouldn\u0027t copy the flow cache logic here.\n\nI don\u0027t know what a sane default would be. My suggestion would be somewhere in the region of 1024 records - so 1024/4 \u003d 256 buckets (BIHASH_KVP_PER_PAGE in 16_8 and 40_8 is 4). That would cover a lot of use cases without being too big, but not too small that bihash will have to keep splitting/expanding. Then we can add a user provided config option as well for use cases expecting many more policies in fast path.\n\nMaybe someone else has a better idea for a default value.\n\nBy the way 2^20 is (1 \u003c\u003c 20), not (2 \u003c\u003c 20) as you have here.",
      "parentUuid": "93821da0_6825519f",
      "revId": "632a7c60035380f7c1eea314eb5563a4e62fd507",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    }
  ]
}
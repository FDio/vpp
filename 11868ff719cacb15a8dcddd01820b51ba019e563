{
  "comments": [
    {
      "key": {
        "uuid": "073b7efb_9f7567e4",
        "filename": "src/plugins/unittest/session_test.c",
        "patchSetId": 2
      },
      "lineNbr": 425,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-05T19:43:07Z",
      "side": 1,
      "message": "Thanks for adding these! ;-)",
      "range": {
        "startLine": 423,
        "startChar": 1,
        "endLine": 425,
        "endChar": 7
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c70dec8a_595eadb6",
        "filename": "src/plugins/unittest/session_test.c",
        "patchSetId": 2
      },
      "lineNbr": 425,
      "author": {
        "id": 1698
      },
      "writtenOn": "2021-08-06T10:02:20Z",
      "side": 1,
      "message": "With pleasure ðŸ˜Š",
      "parentUuid": "073b7efb_9f7567e4",
      "range": {
        "startLine": 423,
        "startChar": 1,
        "endLine": 425,
        "endChar": 7
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6a91f4b9_4f17178a",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 907,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-05T19:43:07Z",
      "side": 1,
      "message": "Let\u0027s call it application_namespace_cleanup() and pass the namespace instead of the index.",
      "range": {
        "startLine": 907,
        "startChar": 0,
        "endLine": 907,
        "endChar": 33
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "83f27f7d_29bedf34",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 907,
      "author": {
        "id": 1698
      },
      "writtenOn": "2021-08-06T10:02:20Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "6a91f4b9_4f17178a",
      "range": {
        "startLine": 907,
        "startChar": 0,
        "endLine": 907,
        "endChar": 33
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "654cefc2_0a2d9636",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 909,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-05T19:43:07Z",
      "side": 1,
      "message": "indices",
      "range": {
        "startLine": 909,
        "startChar": 7,
        "endLine": 909,
        "endChar": 18
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c3130327_2348a269",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 909,
      "author": {
        "id": 1698
      },
      "writtenOn": "2021-08-06T10:02:20Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "654cefc2_0a2d9636",
      "range": {
        "startLine": 909,
        "startChar": 7,
        "endLine": 909,
        "endChar": 18
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7cd71ce2_e9f882c4",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 928,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-05T19:43:07Z",
      "side": 1,
      "message": "I think we should call application_detach_process as we want all workers cleaned up and all sessions closed. The thing we\u0027re missing at this point is a notification towards the app that it\u0027s being cleaned up. That is, we have detach messages from app to vpp but not viceversa. So we should probably enqueue a detach ctrl messages also but we could do that in a separate patch as well.",
      "range": {
        "startLine": 918,
        "startChar": 0,
        "endLine": 928,
        "endChar": 5
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f45b4b35_cf6b4e71",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 928,
      "author": {
        "id": 1698
      },
      "writtenOn": "2021-08-06T10:02:20Z",
      "side": 1,
      "message": "Right,\nThe issue I had regarding this was `application_detach_process` requires an api_client_index which we don\u0027t have. But under the hood it only does `vnet_app_worker_add_del` for each worker, which results in :\n\nforeach app-\u003eapp_wrk {\n  application_api_table_del (app_wrk-\u003eapi_client_index);\n  app_worker_free (app_wrk);\n  app_worker_map_free (app, wrk_map);\n}\napplication_free (app);\n\nUnder the hood, application_free also does (If it hasn\u0027t been done earlier) :\nforeach app-\u003eapp_wrk {\n  app_worker_free (app_wrk);\n  app_worker_map_free (app, wrk_map);\n}\nso adding application_api_table_del to the application_namespace_cleanup call should result in the same logic. But I agree using the same codepath would be nicer.\n\n(1) I\u0027ll change the logic so that `application_detach_process(app, ~0)` does cleanup all app_wrk.\n(2) I\u0027ll add the `application_api_table_del(app_wrk-\u003eapi_client_index)` to application_free\n(3) I\u0027ll do the enqueue detach ctrl message in a separated patch if that\u0027s ok",
      "parentUuid": "7cd71ce2_e9f882c4",
      "range": {
        "startLine": 918,
        "startChar": 0,
        "endLine": 928,
        "endChar": 5
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "adb606d9_ae143916",
        "filename": "src/vnet/session/application.c",
        "patchSetId": 2
      },
      "lineNbr": 928,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-06T16:19:40Z",
      "side": 1,
      "message": "Well that api_client_index is a relic due to our reliance on binary api. It will eventually go away so let\u0027s solve it differently. Going to comment on the new code",
      "parentUuid": "f45b4b35_cf6b4e71",
      "range": {
        "startLine": 918,
        "startChar": 0,
        "endLine": 928,
        "endChar": 5
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2bc39a06_64eef379",
        "filename": "src/vnet/session/application_interface.h",
        "patchSetId": 2
      },
      "lineNbr": 279,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-05T19:43:07Z",
      "side": 1,
      "message": "Let\u0027s move it out of the application interface, i.e., applications should not call this directly. Probably the best place is application.h",
      "range": {
        "startLine": 279,
        "startChar": 0,
        "endLine": 279,
        "endChar": 58
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3258244b_00b9ac40",
        "filename": "src/vnet/session/application_interface.h",
        "patchSetId": 2
      },
      "lineNbr": 279,
      "author": {
        "id": 1698
      },
      "writtenOn": "2021-08-06T10:02:20Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "2bc39a06_64eef379",
      "range": {
        "startLine": 279,
        "startChar": 0,
        "endLine": 279,
        "endChar": 58
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a4be08e0_6c24f72c",
        "filename": "src/vnet/session/application_namespace.c",
        "patchSetId": 2
      },
      "lineNbr": 95,
      "author": {
        "id": 193
      },
      "writtenOn": "2021-08-05T19:43:07Z",
      "side": 1,
      "message": "Although this is a good idea, let\u0027s not have session layer depend on dpo.h. We should probably consider moving index_t to vppinfra and start using it a bit more consistently.",
      "range": {
        "startLine": 95,
        "startChar": 2,
        "endLine": 95,
        "endChar": 9
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "861fc663_cbd0dd7b",
        "filename": "src/vnet/session/application_namespace.c",
        "patchSetId": 2
      },
      "lineNbr": 95,
      "author": {
        "id": 1698
      },
      "writtenOn": "2021-08-06T10:02:20Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "a4be08e0_6c24f72c",
      "range": {
        "startLine": 95,
        "startChar": 2,
        "endLine": 95,
        "endChar": 9
      },
      "revId": "11868ff719cacb15a8dcddd01820b51ba019e563",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "8efcc187_c2e70c14",
        "filename": "src/plugins/tlspicotls/pico_vpp_crypto.c",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 193
      },
      "writtenOn": "2020-11-03T21:39:23Z",
      "side": 1,
      "message": "This might avoid the issue temporarily but unfortunately the issue is the fact that the api is probably not thread safe. Moreover, others could be calling this from other threads. Would it be possible to rpc this to main? If not, I guess we could do this in the interim with a comment above that warns about the issue.",
      "range": {
        "startLine": 122,
        "startChar": 2,
        "endLine": 122,
        "endChar": 25
      },
      "revId": "54330f86e17e62cf61c5a30136d2d0e9884ee6e2",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1e56d7f9_919a94fa",
        "filename": "src/plugins/tlspicotls/pico_vpp_crypto.c",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 888
      },
      "writtenOn": "2020-11-04T01:26:51Z",
      "side": 1,
      "message": "Hi Florin, I\u0027m curious if RPC call will solve this issue, because I check the code in other modules which call this function also, they use the same way that add lock and call this function in worker thread. So there\u0027s no mechanism to handle concurrent conflict between main thread and worker thread also.",
      "parentUuid": "8efcc187_c2e70c14",
      "range": {
        "startLine": 122,
        "startChar": 2,
        "endLine": 122,
        "endChar": 25
      },
      "revId": "54330f86e17e62cf61c5a30136d2d0e9884ee6e2",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "91a35b64_606f9e59",
        "filename": "src/plugins/tlspicotls/pico_vpp_crypto.c",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 193
      },
      "writtenOn": "2020-11-04T02:12:22Z",
      "side": 1,
      "message": "The RPC will take worker barrier and should therefore ensure thread safety. Any other place calling this api from workers, even with per component locks, is likely to crash as the components are probably using independent locks.\n\nAs far as I can tell the crypto functions are registered as callbacks during listen. Does this mean they get called when a new connection is accepted? If yes, rpc-ing from a worker to main to call the function and subsequently back to continue the accept seems rather slow and complicated ...\n\nI wonder if we could make vnet_crypto_key_add thread safe although I see consumers like wg put in the extra effort to avoid calling the function from workers.",
      "parentUuid": "1e56d7f9_919a94fa",
      "range": {
        "startLine": 122,
        "startChar": 2,
        "endLine": 122,
        "endChar": 25
      },
      "revId": "54330f86e17e62cf61c5a30136d2d0e9884ee6e2",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0c979461_39fb6666",
        "filename": "src/plugins/tlspicotls/pico_vpp_crypto.c",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 888
      },
      "writtenOn": "2020-11-04T02:29:08Z",
      "side": 1,
      "message": "Yes, the reason that I\u0027m not using rpc call is the concern of performance, this function is a callback of session accept which will be called frequently especially in CPS test. I think the best way should be make vent_crypto_key_add thread safe or provide a global lock in crypto module which could be used by all other modules?",
      "parentUuid": "91a35b64_606f9e59",
      "range": {
        "startLine": 122,
        "startChar": 2,
        "endLine": 122,
        "endChar": 25
      },
      "revId": "54330f86e17e62cf61c5a30136d2d0e9884ee6e2",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ddb209cd_9906e315",
        "filename": "src/plugins/tlspicotls/pico_vpp_crypto.c",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 193
      },
      "writtenOn": "2020-11-04T02:57:43Z",
      "side": 1,
      "message": "Okay, let\u0027s merge this and ask Damjan if there\u0027s any reason why the api is not thread safe.",
      "parentUuid": "0c979461_39fb6666",
      "range": {
        "startLine": 122,
        "startChar": 2,
        "endLine": 122,
        "endChar": 25
      },
      "revId": "54330f86e17e62cf61c5a30136d2d0e9884ee6e2",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    }
  ]
}
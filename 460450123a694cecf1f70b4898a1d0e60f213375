{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "4ae31453_bd8608dd",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 193
      },
      "writtenOn": "2023-11-27T23:03:23Z",
      "side": 1,
      "message": "Thanks, Dmitry! Was not aware of this. What exactly is failing because it seems only LDP tests are affected?",
      "revId": "460450123a694cecf1f70b4898a1d0e60f213375",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1c01ec53_c6786bec",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 2558
      },
      "writtenOn": "2023-11-28T11:54:28Z",
      "side": 1,
      "message": "Hello, Florin! There are multiple seemingly different issues:\n\nFirst VPP crashes with the following backtrace due to the socket struct being closed and freed in https://git.fd.io/vpp/tree/src/vnet/session/application.c#n1102 / https://git.fd.io/vpp/tree/src/vnet/session/session_api.c#n1407\n\nThis use-after-free likely can be fixed by moving `appns_sapi_free_socket` call to `sapi_add_del_worker_handler`.\n\n```\nThread 1 (Thread 0x7f01f838b1c0 (LWP 1892222)):\n#0  __asan::FakeStack::HandleNoReturn (this\u003d0x0) at ../../../../src/libsanitizer/asan/asan_fake_stack.cc:131\n#1  0x00007f01fb577059 in __asan_handle_no_return () at ../../../../src/libsanitizer/asan/asan_rtl.cc:571\n#2  0x000055b352e5ebd3 in os_exit (code\u003d1) at /home/user/src/gerrit.fd.io/vpp-master/src/vpp/vnet/main.c:445\n#3  0x00007f01f8af5056 in unix_signal_handler (signum\u003d11, si\u003d0x7f01b16f8bb0, uc\u003d0x7f01b16f8a80) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/unix/main.c:177\n#4  \u003csignal handler called\u003e\n#5  0x00007f01fb490635 in __asan::FakeStack::SizeRequiredForFlags (stack_size_log\u003d\u003coptimized out\u003e) at ../../../../src/libsanitizer/asan/asan_fake_stack.h:70\n#6  __asan::FakeStack::GetFrame (pos\u003d0, class_id\u003d0, stack_size_log\u003d\u003coptimized out\u003e, this\u003d0x0) at ../../../../src/libsanitizer/asan/asan_fake_stack.h:114\n#7  __asan::FakeStack::AddrIsInFakeStack (this\u003d0x0, ptr\u003d139645355374616, frame_beg\u003dframe_beg@entry\u003d0x7f01b16f97a8, frame_end\u003dframe_end@entry\u003d0x7f01b16f97b0) at ../../../../src/libsanitizer/asan/asan_fake_stack.cc:116\n#8  0x00007f01fb578ef5 in __asan::FakeStack::AddrIsInFakeStack (addr\u003d\u003coptimized out\u003e, this\u003d\u003coptimized out\u003e) at ../../../../src/libsanitizer/asan/asan_fake_stack.h:134\n#9  __asan::ThreadStackContainsAddress (tctx_base\u003d\u003coptimized out\u003e, addr\u003d\u003coptimized out\u003e) at ../../../../src/libsanitizer/asan/asan_thread.cc:389\n#10 0x00007f01fb59385a in __sanitizer::ThreadRegistry::FindThreadContextLocked (this\u003d0x7f01fb5fc720 \u003c__asan::thread_registry_placeholder\u003e, cb\u003dcb@entry\u003d0x7f01fb578e50 \u003c__asan::ThreadStackContainsAddress(__sanitizer::ThreadContextBase*, void*)\u003e, arg\u003darg@entry\u003d0x7f01b7cd3818) at ../../../../src/libsanitizer/sanitizer_common/sanitizer_thread_registry.cc:196\n#11 0x00007f01fb57a34e in __asan::FindThreadByStackAddress (addr\u003daddr@entry\u003d139645355374616) at ../../../../src/libsanitizer/asan/asan_thread.cc:436\n#12 0x00007f01fb48af6a in __asan::GetStackAddressInformation (addr\u003daddr@entry\u003d139645355374616, access_size\u003daccess_size@entry\u003d8, descr\u003ddescr@entry\u003d0x7f01b16f9d20) at ../../../../src/libsanitizer/asan/asan_descriptions.cc:195\n#13 0x00007f01fb48c3c9 in __asan::AddressDescription::AddressDescription (shouldLockThreadRegistry\u003dfalse, access_size\u003d8, addr\u003d139645355374616, this\u003d0x7f01b16f9d18) at ../../../../src/libsanitizer/asan/asan_descriptions.cc:454\n#14 __asan::AddressDescription::AddressDescription (this\u003d0x7f01b16f9d18, addr\u003d139645355374616, access_size\u003d8, shouldLockThreadRegistry\u003d\u003coptimized out\u003e) at ../../../../src/libsanitizer/asan/asan_descriptions.cc:438\n#15 0x00007f01fb48ee95 in __asan::ErrorGeneric::ErrorGeneric (this\u003d0x7f01b16f9910, tid\u003d\u003coptimized out\u003e, pc_\u003d139646463819818, bp_\u003d139645248578944, sp_\u003d139645248578928, addr\u003d139645355374616, is_write_\u003dfalse, access_size_\u003d8) at ../../../../src/libsanitizer/asan/asan_errors.cc:380\n#16 0x00007f01fb573f4e in __asan::ReportGenericError (pc\u003d139646463819818, bp\u003dbp@entry\u003d139645248578944, sp\u003dsp@entry\u003d139645248578928, addr\u003d139645355374616, is_write\u003dis_write@entry\u003dfalse, access_size\u003daccess_size@entry\u003d8, exp\u003d0, fatal\u003dtrue) at ../../../../src/libsanitizer/asan/asan_report.cc:460\n#17 0x00007f01fb574deb in __asan::__asan_report_load8 (addr\u003d\u003coptimized out\u003e) at ../../../../src/libsanitizer/asan/asan_rtl.cc:119\n#18 0x00007f01f9dec02a in clib_socket_sendmsg (s\u003d0x7f01b7cd37b0, msg\u003d0x7f01b16fa6b0, msglen\u003d209, fds\u003d0x7f01b16fa640, num_fds\u003d0) at /home/user/src/gerrit.fd.io/vpp-master/src/vppinfra/socket.h:182\n#19 0x00007f01f9dfd44a in sapi_add_del_worker_handler (app_ns\u003d0x7f01ba7b58f0, cs\u003d0x7f01b7cd37b0, mp\u003d0x7f01b16fa881) at /home/user/src/gerrit.fd.io/vpp-master/src/vnet/session/session_api.c:1487\n#20 0x00007f01f9dfea2d in sapi_sock_read_ready (cf\u003d0x7f01b95cdb20) at /home/user/src/gerrit.fd.io/vpp-master/src/vnet/session/session_api.c:1651\n#21 0x00007f01f8af0339 in linux_epoll_input_inline (vm\u003d0x7f01b5712740, node\u003d0x7f01b6c40b00, frame\u003d0x0, thread_index\u003d0) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/unix/input.c:318\n#22 0x00007f01f8af0ac0 in linux_epoll_input (vm\u003d0x7f01b5712740, node\u003d0x7f01b6c40b00, frame\u003d0x0) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/unix/input.c:368\n#23 0x00007f01f8a4427d in dispatch_node (vm\u003d0x7f01b5712740, node\u003d0x7f01b6c40b00, type\u003dVLIB_NODE_TYPE_PRE_INPUT, dispatch_state\u003dVLIB_NODE_STATE_POLLING, frame\u003d0x0, last_time_stamp\u003d16644709723650488) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/main.c:960\n#24 0x00007f01f8a48039 in vlib_main_or_worker_loop (vm\u003d0x7f01b5712740, is_main\u003d1) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/main.c:1546\n#25 0x00007f01f8a494b9 in vlib_main_loop (vm\u003d0x7f01b5712740) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/main.c:1726\n#26 0x00007f01f8a4aa3a in vlib_main (vm\u003d0x7f01b5712740, input\u003d0x7f01b16faf70) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/main.c:2037\n#27 0x00007f01f8af7830 in thread0 (arg\u003d139645315786560) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/unix/main.c:586\n#28 0x00007f01f879522c in clib_calljmp () at /home/user/src/gerrit.fd.io/vpp-master/src/vppinfra/longjmp.S:123\n#29 0x00007ffd28cd7c10 in ?? ()\n#30 0x00007f01f8af85ac in vlib_unix_main (argc\u003d70, argv\u003d0x7ffd28cda278) at /home/user/src/gerrit.fd.io/vpp-master/src/vlib/unix/main.c:681\n#31 0x000055b352e5dd5b in main (argc\u003d70, argv\u003d0x7ffd28cda278) at /home/user/src/gerrit.fd.io/vpp-master/src/vpp/vnet/main.c:350\n```\n\nThen iperf fails in ldp_pselect with an invalid memory read I have not fully triaged yet.\n\n```\n    #0 0x7ffb8b5f96d4 in ldp_pselect /home/d-valter/src/gerrit.fd.io/vpp-master/src/vcl/ldp.c:748\n    #1 0x7ffb8b5fac66 in select /home/d-valter/src/gerrit.fd.io/vpp-master/src/vcl/ldp.c:920\n    #2 0x7ffb8b5c516c in iperf_run_server (/lib/x86_64-linux-gnu/libiperf.so.0+0x1916c)\n    #3 0x5592b92f0599  (/usr/bin/iperf3+0x1599)\n    #4 0x5592b92f035d  (/usr/bin/iperf3+0x135d)\n    #5 0x7ffb8b3de082 in __libc_start_main ../csu/libc-start.c:308\n    #6 0x5592b92f042d  (/usr/bin/iperf3+0x142d)\n\nAddress 0x7ffb77613c58 is a wild pointer.\nSUMMARY: AddressSanitizer: use-after-poison /home/d-valter/src/gerrit.fd.io/vpp-master/src/vcl/ldp.c:748 in ldp_pselect\nShadow bytes around the buggy address:\n  0x0fffeeeba730: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba740: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba750: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba760: 00 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 00 f7 f7 f7\n  0x0fffeeeba770: f7 f7 f7 f7 f7 f7 f7 f7 00 00 00 00 00 00 00 00\n\u003d\u003e0x0fffeeeba780: f7 f7 00 00 00 00 f7 f7 f7 f7 f7[f7]f7 f7 f7 f7\n  0x0fffeeeba790: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba7a0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba7b0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba7c0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\n  0x0fffeeeba7d0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n\u003d\u003d1922208\u003d\u003dABORTING\n```\n\nAlso there\u0027s a va-arg overrun in session_cli_show_all_sessions that also crashes VPP in LDPIpv6CutThruTestCase\n```\n#0  __GI_raise (sig\u003dsig@entry\u003d6) at ../sysdeps/unix/sysv/linux/raise.c:50\n#1  0x00007f2dab0ee859 in __GI_abort () at abort.c:79\n#2  0x0000559361c63bd8 in os_exit (code\u003d1) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vpp/vnet/main.c:445\n#3  0x00007f2dab810056 in unix_signal_handler (signum\u003d11, si\u003d0x7f2d60043170, uc\u003d0x7f2d60043040) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlib/unix/main.c:177\n#4  \u003csignal handler called\u003e\n#5  0x00007f2dab48d392 in __vec_len (v\u003d0x2) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/vec_bootstrap.h:129\n#6  0x00007f2dab490c82 in do_percent (_s\u003d0x7f2d60043f40, fmt\u003d0x7f2dad86afa2 \"%v\", va\u003d0x7f2d60043fd0) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/format.c:357\n#7  0x00007f2dab49136a in va_format (s\u003d0x7f2d6d47f668 \"[0:1][CT:T] :::0-\u003e::1:5201\", \u0027 \u0027 \u003crepeats 34 times\u003e, fmt\u003d0x7f2dad86afa0 \"%U%v\", va\u003d0x7f2d60043fd0) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/format.c:408\n#8  0x00007f2dab491543 in format (s\u003d0x0, fmt\u003d0x7f2dad86afa0 \"%U%v\") at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/format.c:432\n#9  0x00007f2dacad6a24 in format_session (s\u003d0x0, args\u003d0x7f2d60044440) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vnet/session/session_cli.c:148\n#10 0x00007f2dab491049 in do_percent (_s\u003d0x7f2d60044380, fmt\u003d0x7f2dad86aec0 \"%U\", va\u003d0x7f2d60044440) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/format.c:377\n#11 0x00007f2dab49136a in va_format (s\u003d0x0, fmt\u003d0x7f2dad86aec0 \"%U\", va\u003d0x7f2d60044440) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/format.c:408\n#12 0x00007f2dab6feeab in vlib_cli_output (vm\u003d0x7f2d6842d740, fmt\u003d0x7f2dad86aec0 \"%U\") at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlib/cli.c:782\n#13 0x00007f2dacad8fab in session_cli_show_all_sessions (vm\u003d0x7f2d6842d740, verbose\u003d2) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vnet/session/session_cli.c:349\n#14 0x00007f2dacadaf5f in show_session_command_fn (vm\u003d0x7f2d6842d740, input\u003d0x7f2d60044d00, cmd\u003d0x7f2d6a9be4a8) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vnet/session/session_cli.c:651\n#15 0x00007f2dab6fe1eb in vlib_cli_dispatch_sub_commands (vm\u003d0x7f2d6842d740, cm\u003d0x559361cbe1f0 \u003cvlib_global_main+48\u003e, input\u003d0x7f2d60044d00, parent_command_index\u003d3) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlib/cli.c:650\n#16 0x00007f2dab6fdc89 in vlib_cli_dispatch_sub_commands (vm\u003d0x7f2d6842d740, cm\u003d0x559361cbe1f0 \u003cvlib_global_main+48\u003e, input\u003d0x7f2d60044d00, parent_command_index\u003d0) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlib/cli.c:607\n#17 0x00007f2dab6fec0a in vlib_cli_input (vm\u003d0x7f2d6842d740, input\u003d0x7f2d60044d00, function\u003d0x7f2dae140ac4 \u003cinband_cli_output\u003e, function_arg\u003d139832861150400) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlib/cli.c:753\n#18 0x00007f2dae140f16 in vl_api_cli_inband_t_handler (mp\u003d0x7f2d6d38b388) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlibmemory/vlib_api.c:117\n#19 0x00007f2dab949bf8 in msg_handler_internal (am\u003d0x7f2dab960380 \u003capi_global_main\u003e, the_msg\u003d0x7f2d6d38b388, msg_len\u003d37, trace_it\u003d1, do_it\u003d1, free_it\u003d0) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlibapi/api_shared.c:576\n#20 0x00007f2dab94a5e7 in vl_msg_api_socket_handler (the_msg\u003d0x7f2d6d38b388, msg_len\u003d37) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlibapi/api_shared.c:729\n#21 0x00007f2dae1176e7 in vl_socket_process_api_msg (rp\u003d0x7f2d6d47fb98, input_v\u003d0x7f2d6d38b378 \"\") at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlibmemory/socket_api.c:207\n#22 0x00007f2dae12bbf0 in vl_api_clnt_process (vm\u003d0x7f2d6842d740, node\u003d0x7f2d699d4b80, f\u003d0x0) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlibmemory/memclnt_api.c:429\n#23 0x00007f2dab760f21 in vlib_process_bootstrap (_a\u003d139832932260704) at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vlib/main.c:1221\n#24 0x00007f2dab4b022c in clib_calljmp () at /home/d-valter/src/gerrit.fd.io/vpp-master/src/vppinfra/longjmp.S:123\n```",
      "parentUuid": "4ae31453_bd8608dd",
      "revId": "460450123a694cecf1f70b4898a1d0e60f213375",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "66ab7416_1d43f759",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 193
      },
      "writtenOn": "2023-11-29T00:20:34Z",
      "side": 1,
      "message": "Thanks for the detailed report! I think Georgy\u0027s patch plus these additional ones solve everything:\n\nhttps://gerrit.fd.io/r/c/vpp/+/40017\nhttps://gerrit.fd.io/r/c/vpp/+/40018\n\nI\u0027ve tested locally with gcc10. If you get a chance to test, let me know if this also works for you.",
      "parentUuid": "1c01ec53_c6786bec",
      "revId": "460450123a694cecf1f70b4898a1d0e60f213375",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    }
  ]
}
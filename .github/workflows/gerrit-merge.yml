name: gerrit-merge

on:
  workflow_dispatch:
    inputs:
      FDIO_NAMESPACE:
        description: "Executor Namespace (prod|sandbox)"
        required: false
        type: choice
        options:
          - sandbox
          - prod
        default: prod
      GERRIT_BRANCH:
        description: "Branch that change is against"
        required: true
        type: string
      GERRIT_CHANGE_ID:
        description: "The ID for the change"
        required: true
        type: string
      GERRIT_CHANGE_NUMBER:
        description: "The Gerrit number"
        required: true
        type: string
      GERRIT_CHANGE_URL:
        description: "URL to the change"
        required: true
        type: string
      GERRIT_EVENT_TYPE:
        description: "Type of Gerrit event"
        required: true
        type: string
      GERRIT_PATCHSET_NUMBER:
        description: "The patch number for the change"
        required: true
        type: string
      GERRIT_PATCHSET_REVISION:
        description: "The revision sha"
        required: true
        type: string
      GERRIT_PROJECT:
        description: "Project in Gerrit"
        required: true
        type: string
      GERRIT_REFSPEC:
        description: "Gerrit refspec of change"
        required: true
        type: string

defaults:
  run:
    shell: bash

permissions:
  contents: read
  actions: read

jobs:
  start-merge:
    name: Start Merge
    runs-on: ubuntu-latest
    outputs:
      log_prefix: ${{ steps.start-time.outputs.log_prefix }}
      docs_changed: ${{ steps.docs-changed.outputs.docs_changed }}
    steps:
      - name: Start Time
        id: start-time
        run: |
          set -euxo pipefail
          timestamp=$(date -u +%Y_%m_%d_%H%M%S_UTC)
          log_prefix="gha-vpp-per-patch/merge-${{ inputs.GERRIT_BRANCH }}-${timestamp}-gerrit-${{ inputs.GERRIT_CHANGE_NUMBER }}-${{ inputs.GERRIT_PATCHSET_NUMBER}}"
          echo "log_prefix=$log_prefix" >> "$GITHUB_OUTPUT"
          echo "Gerrit Change: ${{ inputs.GERRIT_CHANGE_URL }}"

      - name: Actions Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect docs changes
        id: docs-changed
        run: |
          set -euo pipefail

          docs_changed=true
          if git fetch origin "${{ inputs.GERRIT_REFSPEC }}"; then
            if git diff-tree --no-commit-id --name-only -r --root FETCH_HEAD | grep -Eq 'docs/|\.rst$'; then
              docs_changed=true
            else
              docs_changed=false
            fi
          else
            echo "warn: unable to fetch '${{ inputs.GERRIT_REFSPEC }}'; defaulting docs_changed=true" >&2
          fi

          echo "docs_changed=$docs_changed" >> "$GITHUB_OUTPUT"

  merge-docs:
    name: Merge Docs
    needs:
      - start-merge
    if: ${{ needs.start-merge.outputs.docs_changed == 'true' }}
    uses: fdio/vpp/.github/workflows/vpp-merge-docs.yml@master
    with:
      FDIO_NAMESPACE: ${{ inputs.FDIO_NAMESPACE }}
      GERRIT_BRANCH: ${{ inputs.GERRIT_BRANCH }}
      GERRIT_CHANGE_ID: ${{ inputs.GERRIT_CHANGE_ID }}
      GERRIT_CHANGE_NUMBER: ${{ inputs.GERRIT_CHANGE_NUMBER }}
      GERRIT_CHANGE_URL: ${{ inputs.GERRIT_CHANGE_URL }}
      GERRIT_EVENT_TYPE: ${{ inputs.GERRIT_EVENT_TYPE }}
      GERRIT_PATCHSET_NUMBER: ${{ inputs.GERRIT_PATCHSET_NUMBER }}
      GERRIT_PATCHSET_REVISION: ${{ inputs.GERRIT_PATCHSET_REVISION }}
      GERRIT_PROJECT: ${{ inputs.GERRIT_PROJECT }}
      GERRIT_REFSPEC: ${{ inputs.GERRIT_REFSPEC }}
      LOG_PREFIX: ${{ needs.start-merge.outputs.log_prefix }}
    secrets: inherit

  merge-maketest:
    name: Merge Maketest
    needs:
      - start-merge
      - merge-docs
    if: ${{ needs.start-merge.result == 'success' && (needs.merge-docs.result == 'success' || needs.merge-docs.result == 'skipped') }}
    uses: fdio/vpp/.github/workflows/vpp-merge-maketest.yml@master
    with:
      FDIO_NAMESPACE: ${{ inputs.FDIO_NAMESPACE }}
      GERRIT_BRANCH: ${{ inputs.GERRIT_BRANCH }}
      GERRIT_CHANGE_ID: ${{ inputs.GERRIT_CHANGE_ID }}
      GERRIT_CHANGE_NUMBER: ${{ inputs.GERRIT_CHANGE_NUMBER }}
      GERRIT_CHANGE_URL: ${{ inputs.GERRIT_CHANGE_URL }}
      GERRIT_EVENT_TYPE: ${{ inputs.GERRIT_EVENT_TYPE }}
      GERRIT_PATCHSET_NUMBER: ${{ inputs.GERRIT_PATCHSET_NUMBER }}
      GERRIT_PATCHSET_REVISION: ${{ inputs.GERRIT_PATCHSET_REVISION }}
      GERRIT_PROJECT: ${{ inputs.GERRIT_PROJECT }}
      GERRIT_REFSPEC: ${{ inputs.GERRIT_REFSPEC }}
      LOG_PREFIX: ${{ needs.start-merge.outputs.log_prefix }}
    secrets: inherit

{
  "comments": [
    {
      "key": {
        "uuid": "30cd641a_8e559e9a",
        "filename": "src/vnet/interface_output.h",
        "patchSetId": 8
      },
      "lineNbr": 143,
      "author": {
        "id": 11
      },
      "writtenOn": "2020-06-03T06:24:44Z",
      "side": 1,
      "message": "We cannot be sure there is always an outer header. May be the vnet_get_outer_header() call should return error if outer header does not exist?  Nevertheless, I do think it make sense to have separate VNET_BUFFER_F_OFFLOAD_OUTER... bits to distinguish between outer/inner header checksum offload need so even for tunnel packets, we don\u0027t do unnecessary checksum calculations here.  Otherwise, isn\u0027t it more reasonable to always do the outer header checksum only?  \nI still don\u0027t understand why we have interface_output_node_inline() calling this function always setting with_gso\u003d1 where we parse the header to find L3 and L4 headers again and then only do inner checksum in the original code?  Should with_gso value not be be tied to VNET_BUFFER_F_GSO bit which may indicate the l3/4_hdr_offset are not available so we need to parse the header?",
      "range": {
        "startLine": 143,
        "startChar": 6,
        "endLine": 143,
        "endChar": 28
      },
      "revId": "ef6485b1765b137ce7f5d158a6a1dc40b173fd73",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8640da1f_326dfeea",
        "filename": "src/vnet/interface_output.h",
        "patchSetId": 8
      },
      "lineNbr": 143,
      "author": {
        "id": 2123
      },
      "writtenOn": "2020-06-03T08:58:44Z",
      "side": 1,
      "message": "vnet_get_outer_header() will do nothing if there is no outer header and no functions will be called because if we don\u0027t have outer header we also don\u0027t have GHO_F_OUTER_IP4/6.\n\nI agree that it is better to calculate checksum only for outer packet here or add new _OUTER flag to buffer to don\u0027t calculate unnecessary checksums, but for this patch I want to have VXLAN IPv6 feature work without breaking other stuff. I think we can extend tunnel nodes with checksum offload calculation for inner packets like it is done here: https://gerrit.fd.io/r/c/vpp/+/27395 and then keep only outer header checksum calculation in interface_output node.\n\nI don\u0027t have full understanding of this `with_gso` flag. As I see before 1bd2c019eba5c893d634cc496bd6d54c00020d7e there were two versions of calc_checksums() function one in interface_output.c (with generic header offset calculation) and one without (used in ip4/6_forward.c). So I\u0027m not sure if this `with_gso` flag is really means that bufer has GSO enabled.\n\nPlease feel free to correct me if I missed something.",
      "parentUuid": "30cd641a_8e559e9a",
      "range": {
        "startLine": 143,
        "startChar": 6,
        "endLine": 143,
        "endChar": 28
      },
      "revId": "ef6485b1765b137ce7f5d158a6a1dc40b173fd73",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "97fbffe2_e8931dfa",
        "filename": "src/vnet/interface_output.h",
        "patchSetId": 8
      },
      "lineNbr": 143,
      "author": {
        "id": 11
      },
      "writtenOn": "2020-06-04T04:54:59Z",
      "side": 1,
      "message": "I actually think the correct fix would be for interface-output node to call this calc_checksums() function setting with_gso param to 0. The job for interface-output node is to handle one checksum calculation according to checksum offload meta data in vnet buffer, either via NIC HW checksum offload, if it is available, or call calc_checksum() here using the same metadata info.  This fix in combination of patch-27395, for which I also commented, would fix the VXLAN over IPv6 problem.  The current change here would cause inner checksum to be done twice, once by the change in patch-27395 and again here, which is really wasteful.\nI even wonder if there is a case this function should be called where with_gso parameter is set so we need to parse the packet header because what\u0027s in vnet buffer metadata for checksum offload is not correct?  If there is a case interface-output node would be in this situation, then the result of parsing the header should also be used for NIC HW offload which means packet parsing should not be done in this function which is only called because NIC HW offload is not available.",
      "parentUuid": "8640da1f_326dfeea",
      "range": {
        "startLine": 143,
        "startChar": 6,
        "endLine": 143,
        "endChar": 28
      },
      "revId": "ef6485b1765b137ce7f5d158a6a1dc40b173fd73",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2",
      "unresolved": true
    }
  ]
}
{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "bb250e0c_98b19764",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 241
      },
      "writtenOn": "2025-06-30T11:57:54Z",
      "side": 1,
      "message": "Because of performance reasons, can\u0027t merge this patch which introduce copying buffer_length data to n packets.",
      "revId": "471cdd1bcfc79590298507d18e1be33fdf2882f4",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4a8dc867_0bc4c164",
        "filename": "src/vnet/l2/l2_flood.c",
        "patchSetId": 7
      },
      "lineNbr": 223,
      "author": {
        "id": 267
      },
      "writtenOn": "2025-06-30T04:14:49Z",
      "side": 1,
      "message": "cloning a buffer n times results in n+1 buffers; n are \u0027short\u0027 (sized by the last parameter in the clone function - I\u0027ll call this the \u0027common\u0027 length) and 1, that is shared by the n, is \u0027long\u0027.\nif we use `b-\u003ecurrent_length` as the common length we are copying a lot more data than we need to. and the length of the shared buffer is 0 (for non-chained buffers).\n\ncan you show a packet, and ideally write a unit test, that demonstrates the issue you see.",
      "revId": "471cdd1bcfc79590298507d18e1be33fdf2882f4",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "15423087_478dcbfd",
        "filename": "src/vnet/l2/l2_flood.c",
        "patchSetId": 7
      },
      "lineNbr": 223,
      "author": {
        "id": 3219
      },
      "writtenOn": "2025-06-30T07:29:27Z",
      "side": 1,
      "message": "Thank you for your clarification, I realize that my fix require much more copy than it was before , but I\u0027m afraid it is necessary\n\nFor show the packet I need to revert the change and reproduce the issue once more, it is rather problematic for me now , but I have the vpp trace before and after the fix - kept it especially for this case. Please, look below. Pay attention to packet length  and eth header.\n\nRelating to the unit test - it is the configuration including vrf , which includes bridge domain without BVI  and this bridge domain includes 3 port-vlan l2-interfaces. I don\u0027t have it ready in vpp cli.\n\n\nTrace without fix\n\n\n\n\n\n00:01:26:931242: dpdk-input\n  hge0/0 rx queue 0\n  buffer 0x4aa98c: current data 0, length 1518, buffer-pool 0, ref-count 1, trace handle 0x1000000\n                   ext-hdr-valid \n  PKT MBUF: port 0, nb_segs 1, pkt_len 1518\n    buf_len 10368, data_len 1518, ol_flags 0x2186, data_off 128, phys_addr 0xd2aa6380\n    packet_type 0x291 l2_len 0 l3_len 0 outer_l2_len 0 outer_l3_len 0 \n    rss 0x9ff09ff0 fdir.hi 0x28 fdir.lo 0x9ff09ff0\n    Packet Offload Flags\n      PKT_RX_FDIR (0x0004) RX packet with FDIR infos\n      PKT_RX_FDIR_ID (0x2000) RX packet with FDIR_ID info\n      PKT_RX_IP_CKSUM_GOOD (0x0080) IP cksum of RX pkt. is valid\n      PKT_RX_L4_CKSUM_GOOD (0x0100) L4 cksum of RX pkt. is valid\n      PKT_RX_RSS_HASH (0x0002) RX packet with RSS hash result\n    Packet Types\n      RTE_PTYPE_L2_ETHER (0x0001) Ethernet packet\n      RTE_PTYPE_L3_IPV4_EXT_UNKNOWN (0x0090) IPv4 packet with or without extension headers\n      RTE_PTYPE_L4_UDP (0x0200) UDP packet\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1000\n  UDP: 16.0.0.176 -\u003e 48.0.0.176\n    tos 0x00, ttl 64, length 1500, checksum 0x33b1 dscp CS0 ecn NON_ECN\n    fragment id 0x0001\n  UDP: 23233 -\u003e 53\n    length 1480, checksum 0xfdad\n00:01:26:931271: ethernet-input\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1000\n00:01:26:931291: l2-input\n  l2-input: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e [l2-input-vtr l2-learn l2-fwd l2-flood l2-flood ]\n00:01:26:931297: l2-input-vtr\n  l2-input-vtr: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e data 08 00 45 00 05 dc 00 01 00 00 40 11\n00:01:26:931302: l2-learn\n  l2-learn: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e bd_index 19\n00:01:26:931309: l2-fwd\n  l2-fwd:   sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e bd_index 19 result [0xffffffffffffffff, -1] static age-not bvi filter learn-event learn-move \n\n00:01:26:931321: l2-flood\n  l2-flood: sw_if_index 35 dst 78:78:78:78:78:78 src 78:78:78:78:78:78 bd_index 19\n00:01:26:931335: l2-output\n  l2-output: sw_if_index 37 dst 78:78:78:78:78:78 src 78:78:78:78:78:78 data 81 00 03 ea 78 78 78 78 78 78 78 78\n00:01:26:931342: hge0/0-output\n  hge0/0.1002 flags 0x1018000d\n  0x7878: 78:78:78:78:78:78 -\u003e 78:78:78:78:78:78 802.1q vlan 1002\n00:01:26:931362: hge0/0-tx\n  hge0/0 tx queue 1\n  buffer 0x4aa98c: current data 256, length 1262, buffer-pool 0, ref-count 1, trace handle 0x1000000\n                   ext-hdr-valid \n                   vlan-1-deep l2-hdr-offset 0 l3-hdr-offset 18 \n  PKT MBUF: port 0, nb_segs 1, pkt_len 1262\n    buf_len 10368, data_len 1262, ol_flags 0x2186, data_off 384, phys_addr 0xd2aa6380\n    packet_type 0x291 l2_len 0 l3_len 0 outer_l2_len 0 outer_l3_len 0 \n    rss 0x9ff09ff0 fdir.hi 0x28 fdir.lo 0x9ff09ff0\n    Packet Offload Flags\n      PKT_RX_FDIR (0x0004) RX packet with FDIR infos\n      PKT_RX_FDIR_ID (0x2000) RX packet with FDIR_ID info\n      PKT_RX_IP_CKSUM_GOOD (0x0080) IP cksum of RX pkt. is valid\n      PKT_RX_L4_CKSUM_GOOD (0x0100) L4 cksum of RX pkt. is valid\n      PKT_RX_RSS_HASH (0x0002) RX packet with RSS hash result\n    Packet Types\n      RTE_PTYPE_L2_ETHER (0x0001) Ethernet packet\n      RTE_PTYPE_L3_IPV4_EXT_UNKNOWN (0x0090) IPv4 packet with or without extension headers\n      RTE_PTYPE_L4_UDP (0x0200) UDP packet\n  0x7878: 78:78:78:78:78:78 -\u003e 78:78:78:78:78:78 802.1q vlan 1002\n  \n  \n\n\n\n\n\n\n\n\n\n\nTrace with the fix \n\n\n\n\n\n\n\n00:03:30:439678: dpdk-input\n  hge0/0 rx queue 0\n  buffer 0x492fa18: current data 0, length 1518, buffer-pool 0, ref-count 1, trace handle 0x1000000\n                    ext-hdr-valid \n  PKT MBUF: port 0, nb_segs 1, pkt_len 1518\n    buf_len 10368, data_len 1518, ol_flags 0x2186, data_off 128, phys_addr 0xe4be8680\n    packet_type 0x291 l2_len 0 l3_len 0 outer_l2_len 0 outer_l3_len 0 \n    rss 0xf128f128 fdir.hi 0x28 fdir.lo 0xf128f128\n    Packet Offload Flags\n      PKT_RX_FDIR (0x0004) RX packet with FDIR infos\n      PKT_RX_FDIR_ID (0x2000) RX packet with FDIR_ID info\n      PKT_RX_IP_CKSUM_GOOD (0x0080) IP cksum of RX pkt. is valid\n      PKT_RX_L4_CKSUM_GOOD (0x0100) L4 cksum of RX pkt. is valid\n      PKT_RX_RSS_HASH (0x0002) RX packet with RSS hash result\n    Packet Types\n      RTE_PTYPE_L2_ETHER (0x0001) Ethernet packet\n      RTE_PTYPE_L3_IPV4_EXT_UNKNOWN (0x0090) IPv4 packet with or without extension headers\n      RTE_PTYPE_L4_UDP (0x0200) UDP packet\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1000\n  UDP: 16.0.10.206 -\u003e 48.0.0.216\n    tos 0x00, ttl 64, length 1500, checksum 0x296b dscp CS0 ecn NON_ECN\n    fragment id 0x0001\n  UDP: 24885 -\u003e 53\n    length 1480, checksum 0xecf3\n00:03:30:439761: ethernet-input\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1000\n00:03:30:439826: l2-input\n  l2-input: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e [l2-input-vtr l2-learn l2-fwd  l2-flood l2-flood ]\n00:03:30:439836: l2-input-vtr\n  l2-input-vtr: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e data 08 00 45 00 05 dc 00 01 00 00 40 11\n00:03:30:439846: l2-learn\n  l2-learn: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e bd_index 19\n00:03:30:439856: l2-fwd\n  l2-fwd:   sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e bd_index 19 result [0xffffffffffffffff, -1] static age-not bvi filter learn-event learn-move \n00:03:30:439875: l2-flood\n  l2-flood: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e bd_index 19\n  l2-flood: sw_if_index 35 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e bd_index 19\n00:03:30:439928: l2-output\n  l2-output: sw_if_index 37 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e data 81 00 03 ea 08 00 45 00 05 dc 00 01\n  l2-output: sw_if_index 36 dst b8:ce:f6:f2:db:1f src b8:ce:f6:f2:db:1e data 81 00 03 e9 08 00 45 00 05 dc 00 01\n00:03:30:439991: hge0/0-output\n  hge0/0.1002 flags 0x1018000d\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1002\n  UDP: 16.0.10.206 -\u003e 48.0.0.216\n    tos 0x00, ttl 64, length 1500, checksum 0x296b dscp CS0 ecn NON_ECN\n    fragment id 0x0001\n  UDP: 24885 -\u003e 53\n    length 1480, checksum 0xecf3\n  hge0/0.1001 flags 0x10180005\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1001\n  UDP: 16.0.10.206 -\u003e 48.0.0.216\n    tos 0x00, ttl 64, length 1500, checksum 0x296b dscp CS0 ecn NON_ECN\n    fragment id 0x0001\n  UDP: 24885 -\u003e 53\n    length 1480, checksum 0xecf3\n00:03:30:440007: hge0/0-tx\n  hge0/0 tx queue 1\n  buffer 0x492fa18: current data 0, length 1518, buffer-pool 0, ref-count 1, trace handle 0x1000000\n                    ext-hdr-valid \n                    vlan-1-deep l2-hdr-offset 0 l3-hdr-offset 18 \n  PKT MBUF: port 0, nb_segs 1, pkt_len 1518\n    buf_len 10368, data_len 1518, ol_flags 0x2186, data_off 128, phys_addr 0xe4be8680\n    packet_type 0x291 l2_len 0 l3_len 0 outer_l2_len 0 outer_l3_len 0 \n    rss 0xf128f128 fdir.hi 0x28 fdir.lo 0xf128f128\n    Packet Offload Flags\n      PKT_RX_FDIR (0x0004) RX packet with FDIR infos\n      PKT_RX_FDIR_ID (0x2000) RX packet with FDIR_ID info\n      PKT_RX_IP_CKSUM_GOOD (0x0080) IP cksum of RX pkt. is valid\n      PKT_RX_L4_CKSUM_GOOD (0x0100) L4 cksum of RX pkt. is valid\n      PKT_RX_RSS_HASH (0x0002) RX packet with RSS hash result\n    Packet Types\n      RTE_PTYPE_L2_ETHER (0x0001) Ethernet packet\n      RTE_PTYPE_L3_IPV4_EXT_UNKNOWN (0x0090) IPv4 packet with or without extension headers\n      RTE_PTYPE_L4_UDP (0x0200) UDP packet\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1002\n  UDP: 16.0.10.206 -\u003e 48.0.0.216\n    tos 0x00, ttl 64, length 1500, checksum 0x296b dscp CS0 ecn NON_ECN\n    fragment id 0x0001\n  UDP: 24885 -\u003e 53\n    length 1480, checksum 0xecf3\n  hge0/0 tx queue 1\n  buffer 0x4863533: current data 0, length 1518, buffer-pool 0, ref-count 1, trace handle 0x1000000\n                    vlan-1-deep l2-hdr-offset 0 l3-hdr-offset 18 \n  PKT MBUF: port 65535, nb_segs 1, pkt_len 1518\n    buf_len 10368, data_len 1518, ol_flags 0x0, data_off 128, phys_addr 0xe18d4d40\n    packet_type 0x0 l2_len 0 l3_len 0 outer_l2_len 0 outer_l3_len 0 \n    rss 0x0 fdir.hi 0x0 fdir.lo 0x0\n  IP4: b8:ce:f6:f2:db:1e -\u003e b8:ce:f6:f2:db:1f 802.1q vlan 1001\n  UDP: 16.0.10.206 -\u003e 48.0.0.216\n    tos 0x00, ttl 64, length 1500, checksum 0x296b dscp CS0 ecn NON_ECN\n    fragment id 0x0001\n  UDP: 24885 -\u003e 53\n    length 1480, checksum 0xecf3",
      "parentUuid": "4a8dc867_0bc4c164",
      "revId": "471cdd1bcfc79590298507d18e1be33fdf2882f4",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    }
  ]
}
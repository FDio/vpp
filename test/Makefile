.PHONY: verify-python-path

verify-python-path:
ifndef VPP_PYTHON_PREFIX
	$(error VPP_PYTHON_PREFIX is not set)
endif

PYTHON_VENV_PATH=$(VPP_PYTHON_PREFIX)/virtualenv
SITE_PACKAGES=$(PYTHON_VENV_PATH)/site-packages
SCAPY_PKG=scapy==2.3.3
SCAPY_INSTALL_PATH=$(SITE_PACKAGES)/scapy
PEXPECT_PKG=pexpect
PEXPECT_INSTALL_PATH=$(SITE_PACKAGES)/pexpect
BUILD_COV_DIR = $(BR)/test-cov

$(PYTHON_VENV_PATH):
	@virtualenv $(PYTHON_VENV_PATH) -p /usr/bin/pypy

SCAPY_PATCH_DONE=$(VPP_PYTHON_PREFIX)/scapy-patch.done

$(SCAPY_INSTALL_PATH): $(PYTHON_VENV_PATH)
	@rm -f $(SCAPY_PATCH_DONE)
	@bash -c "source $(PYTHON_VENV_PATH)/bin/activate && pip install $(SCAPY_PKG)"

$(PEXPECT_INSTALL_PATH): $(PYTHON_VENV_PATH)
	@bash -c "source $(PYTHON_VENV_PATH)/bin/activate && pip install $(PEXPECT_PKG)"

SCAPY_PATCHES:= $(wildcard $(CURDIR)/patches/scapy-2.3.3/*.patch)

$(SCAPY_PATCH_DONE): $(PYTHON_VENV_PATH) $(SCAPY_PATCHES) $(SCAPY_INSTALL_PATH)
	@echo --- patching ---
	for f in $(SCAPY_PATCHES) ; do \
		echo Applying patch: $$(basename $$f) ; \
		patch -p1 -d $(SITE_PACKAGES) < $$f ; \
	done
	@touch $@

pneum_wrap_setup: pneum_wrap/setup.py pneum_wrap/pneum_wrap_extra_code.c pneum_wrap/pneum_wrap_extra_defs.h pneum_wrap/build_pneum_wrap.py $(PYTHON_VENV_PATH)
	bash -c "source $(PYTHON_VENV_PATH)/bin/activate && pip install --force-reinstall ./pneum_wrap"

DEPENDENCIES = $(VPP_PYTHON_PREFIX)/.dependencies
.PHONY: $(DEPENDENCIES) pneum_wrap_setup

$(DEPENDENCIES): $(SCAPY_PATCH_DONE) $(PEXPECT_INSTALL_PATH) pneum_wrap_setup
	@touch $@

define retest-func
	@bash -c "source $(PYTHON_VENV_PATH)/bin/activate && pypy run_tests.py discover -p test_$(TEST)\"*.py\""
endef

test: reset verify-python-path $(DEPENDENCIES)
	$(call retest-func)

retest: reset verify-python-path
	$(call retest-func)

.PHONY: wipe doc

reset:
	@rm -f /dev/shm/vpp-unittest-*
	@rm -rf /tmp/vpp-unittest-*

wipe: reset
	@rm -rf $(PYTHON_VENV_PATH)

doc: verify-python-path
	@virtualenv $(PYTHON_VENV_PATH)
	@bash -c "source $(PYTHON_VENV_PATH)/bin/activate && pip install $(PYTHON_DEPENDS) sphinx"
	@bash -c "source $(PYTHON_VENV_PATH)/bin/activate && make -C doc WS_ROOT=$(WS_ROOT) BR=$(BR) NO_VPP_PAPI=1 html"

.PHONY: wipe-doc

wipe-doc:
	@make -C doc wipe BR=$(BR)

cov: wipe-cov reset verify-python-path $(DEPENDENCIES)
	@lcov --zerocounters --directory $(VPP_TEST_BUILD_DIR)
	$(call retest-func)
	@mkdir $(BUILD_COV_DIR)
	@lcov --capture --directory $(VPP_TEST_BUILD_DIR) --output-file $(BUILD_COV_DIR)/coverage.info
	@genhtml $(BUILD_COV_DIR)/coverage.info --output-directory $(BUILD_COV_DIR)/html
	@echo
	@echo "Build finished. Code coverage report is in $(BUILD_COV_DIR)/html/index.html"

.PHONY: wipe-cov

wipe-cov: wipe
	@rm -rf $(BUILD_COV_DIR)

help:
	@echo "Running tests:"
	@echo ""
	@echo " test                - build and run functional tests"
	@echo " test-debug          - build and run functional tests (debug build)"
	@echo " retest              - run functional tests"
	@echo " retest-debug        - run functional tests (debug build)"
	@echo " test-wipe           - wipe (temporary) files generated by unit tests"
	@echo ""
	@echo "Arguments controlling test runs:"
	@echo " V=[0|1|2]            - set test verbosity level"
	@echo " DEBUG=<type>         - set VPP debugging kind"
	@echo "    DEBUG=core        - detect coredump and load it in gdb on crash"
	@echo "    DEBUG=gdb         - allow easy debugging by printing VPP PID "
	@echo "                        and waiting for user input before running "
	@echo "                        and tearing down a testcase"
	@echo "    DEBUG=gdbserver   - run gdb inside a gdb server, otherwise "
	@echo "                        same as above"
	@echo " STEP=[yes|no]        - ease debugging by stepping through a testcase "
	@echo " TEST=<name>          - only run specific test"
	@echo ""
	@echo "Creating test documentation"
	@echo " test-doc            - generate documentation for test framework"
	@echo " test-wipe-doc       - wipe documentation for test framework"
	@echo ""
	@echo "Creating test code coverage report"
	@echo " test-cov            - generate code coverage report for test framework"
	@echo " test-wipe-cov       - wipe code coverage report for test framework"
	@echo ""

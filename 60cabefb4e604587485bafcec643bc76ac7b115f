{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "cfc57800_8689e85b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 2421
      },
      "writtenOn": "2022-09-02T13:35:48Z",
      "side": 1,
      "message": "Thanks for the review, I have modified the patch accordingly. I have also added IPv4 tests. \n\nUnfortunately, I was unable to add IPv6 tests because of a bug I notified in the ipsec_add_sa_v3 API: if the SA is inbound and has udp encap but no tunnel, the dst port will be registered in IPv4 (we have no info in the SA if it is an IPv4 SA or IPv6 SA in that case). I\u0027ll address that in a future patch.",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce79f7b9_3256a2a6",
        "filename": "src/vnet/ipsec/ipsec.api",
        "patchSetId": 2
      },
      "lineNbr": 202,
      "author": {
        "id": 267
      },
      "writtenOn": "2022-09-01T01:23:12Z",
      "side": 1,
      "message": "i\u0027d make this explicit about what parameters are allowed to be updated. If you pass a full SA representation, then the API expectation are not met. maybe:\n\n/**\n * An API to update the tunnel parameters associated with an SA\n * Used in the NAT-T case when the NAT data changes\n */\nautoreply define ipsec_sad_entry_update_tunnel\n{\n  u32 client_index;\n  u32 context;\n  u32 sad_id;\n  vl_api_tunnel_t tunnel;\n  u16 udp_src_port [default\u003d0xffff];\n  u16 udp_dst_port [default\u003d0xffff];\n};",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a35c023f_27e909f0",
        "filename": "src/vnet/ipsec/ipsec.api",
        "patchSetId": 2
      },
      "lineNbr": 202,
      "author": {
        "id": 2421
      },
      "writtenOn": "2022-09-02T13:35:48Z",
      "side": 1,
      "message": "Agreed, I have added also a is_tun bool so that we could update only the ports.",
      "parentUuid": "ce79f7b9_3256a2a6",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "30e36fbc_ec562421",
        "filename": "src/vnet/ipsec/ipsec_sa.c",
        "patchSetId": 2
      },
      "lineNbr": 189,
      "author": {
        "id": 267
      },
      "writtenOn": "2022-09-01T01:23:12Z",
      "side": 1,
      "message": "are you sure about this? The peer would need to change its salt too.",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9e90babe_6a5ebb28",
        "filename": "src/vnet/ipsec/ipsec_sa.c",
        "patchSetId": 2
      },
      "lineNbr": 189,
      "author": {
        "id": 2421
      },
      "writtenOn": "2022-09-02T13:35:48Z",
      "side": 1,
      "message": "Agreed, it should not be there. I don\u0027t think we should allow crypto material update as this should engender a complete rekey.",
      "parentUuid": "30e36fbc_ec562421",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "69f4bfbd_c0384514",
        "filename": "src/vnet/ipsec/ipsec_sa.c",
        "patchSetId": 2
      },
      "lineNbr": 192,
      "author": {
        "id": 267
      },
      "writtenOn": "2022-09-01T01:23:12Z",
      "side": 1,
      "message": "if the source address has changed for an inbound SA, then the ipsec_tun.c DB needs updating.",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "765c6138_333a23d0",
        "filename": "src/vnet/ipsec/ipsec_sa.c",
        "patchSetId": 2
      },
      "lineNbr": 192,
      "author": {
        "id": 2421
      },
      "writtenOn": "2022-09-02T13:35:48Z",
      "side": 1,
      "message": "Done! As we cannot know if an SA is under a tunnel protection without browsing all the interface protect structures, I simply do a lookup in tun4_protect_by_key for the old source address and change the key of the kv pair if the entry exists.\n\nI thought of using IS_PROTECT of IS_INBOUND but IS_PROTECT is not set if the protection happens over an ipsec interface (thus it was failing my test)",
      "parentUuid": "69f4bfbd_c0384514",
      "revId": "60cabefb4e604587485bafcec643bc76ac7b115f",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    }
  ]
}
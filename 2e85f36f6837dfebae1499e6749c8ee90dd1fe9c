{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "b17ce411_fc85e7a3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1849
      },
      "writtenOn": "2024-05-27T07:52:04Z",
      "side": 1,
      "message": "recheck",
      "revId": "2e85f36f6837dfebae1499e6749c8ee90dd1fe9c",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "16b0dfe0_35497725",
        "filename": "src/vnet/ipsec/ipsec_input.c",
        "patchSetId": 4
      },
      "lineNbr": 561,
      "author": {
        "id": 361
      },
      "writtenOn": "2024-05-24T16:45:18Z",
      "side": 1,
      "message": "Also I\u0027m not sure we should enforce src port is 4500, because NAT can change the source port - and that\u0027s the purpose of UDP encap for IPsec, going through NAT ðŸ˜Š\nI think the only thing we can rely on is dst port is 4500, and that the dest IP address matches one of our local addresses (but that might be more tricky to check).\nThat\u0027s what we do in tunnel mode: any UDP packets destined to us on port 4500 is delivered to IPsec, whatever the source port.\nMaybe the best should be to just program a skip rule automatically by default for udp dest port 4500?\nThat way packets destined to udp port 4500 will follow regular processing, but the user can always override this",
      "revId": "2e85f36f6837dfebae1499e6749c8ee90dd1fe9c",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a1498df5_fc5a09d1",
        "filename": "src/vnet/ipsec/ipsec_input.c",
        "patchSetId": 4
      },
      "lineNbr": 561,
      "author": {
        "id": 1849
      },
      "writtenOn": "2024-05-27T08:30:17Z",
      "side": 1,
      "message": "The change was based on https://www.rfc-editor.org/rfc/rfc4306.html#section-2:\n\n\"IKE normally listens and sends on UDP port 500, though IKE messages\n may also be received on UDP port 4500 with a slightly different\n format\"\n\nAlso in https://datatracker.ietf.org/doc/html/rfc3947#section-4\n\n\"IPsec-aware NATs can cause problems ... Some NATs will not change IKE source \n port 500 even if there are multiple clients behind the NAT ... Take the common \n case of the initiator behind the NAT.  The initiator must quickly change to port \n 4500 once the NAT has been detected to minimize the window of IPsec-aware NAT \n problems. ... In Main Mode, ...  The initiator MUST set both UDP source and \n destination ports to 4500.  All subsequent packets sent to this peer ... MUST be \n sent on port 4500.\"\n\nAnd in https://datatracker.ietf.org/doc/html/rfc3948#section-1\n\n\"The UDP port numbers are the same as those used by IKE traffic, as defined in \n [RFC3947].\"\n\nThe skip rule is a good idea - but not done in IPsec SA add action, as the ipip mode of IPsec SA will not like it (the packets will goes into ipsec-input to do a skip rule check, and then goes into ipip tunnel for a header lookup). But this is something we can do in ike node.",
      "parentUuid": "16b0dfe0_35497725",
      "revId": "2e85f36f6837dfebae1499e6749c8ee90dd1fe9c",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "096012f9_3747a52d",
        "filename": "src/vnet/ipsec/ipsec_input.c",
        "patchSetId": 4
      },
      "lineNbr": 561,
      "author": {
        "id": 361
      },
      "writtenOn": "2024-05-27T09:04:36Z",
      "side": 1,
      "message": "What is the usecase you have in mind here?\nThe peer will set src port to 500/4500 but the NAT will rewrite this src port to something arbitrary. The very purpose of UDP encap is to go through NAT, and NAT will rewrite src port, you won\u0027t receive packets with UDP src port set to 500/4500 unless it\u0027s coming from the local host.",
      "parentUuid": "a1498df5_fc5a09d1",
      "revId": "2e85f36f6837dfebae1499e6749c8ee90dd1fe9c",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3d154e4c_14781f01",
        "filename": "src/vnet/ipsec/ipsec_input.c",
        "patchSetId": 4
      },
      "lineNbr": 561,
      "author": {
        "id": 1849
      },
      "writtenOn": "2024-05-27T09:58:50Z",
      "side": 1,
      "message": "You are right. I also found the statement in my original email responding your question: \n\nhttps://datatracker.ietf.org/doc/html/rfc5996#section-2.11\n\n\"An implementation MUST\n   accept incoming requests even if the source port is not 500 or 4500,\n   and MUST respond to the address and port from which the request was\n   received. \n\"\n\nNew revision pushed. Thanks!",
      "parentUuid": "096012f9_3747a52d",
      "revId": "2e85f36f6837dfebae1499e6749c8ee90dd1fe9c",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7ea81664_9d3358b1",
        "filename": "src/vnet/ipsec/ipsec_input.c",
        "patchSetId": 4
      },
      "lineNbr": 561,
      "author": {
        "id": 361
      },
      "writtenOn": "2024-05-27T16:09:35Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "3d154e4c_14781f01",
      "revId": "2e85f36f6837dfebae1499e6749c8ee90dd1fe9c",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    }
  ]
}
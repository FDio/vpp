{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "dea9e6aa_1136577e",
        "filename": "build-data/packages/vpp.mk",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 361
      },
      "writtenOn": "2025-01-08T13:12:52Z",
      "side": 1,
      "message": "Can we use something like VPP_MAX_WORKERS instead? I think it would be more clear and would allow to be use in other part of the code where we make assumptions on the #workers",
      "revId": "6a4ea8db9f4595ce1373677ad8d3d43c7d9f21c9",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b17b8e22_62e5b07c",
        "filename": "build-data/packages/vpp.mk",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 3171
      },
      "writtenOn": "2025-01-08T14:06:11Z",
      "side": 1,
      "message": "MAX_NELTS is basically the total amount of threads (including main) + 8 (I\u0027m not exactly sure why), and the final value must be the power of 2. It would be slightly misleading for a user (and for 64, you\u0027ll get 55 workers + main thread), or the user will need to set weird values like 23, 55, 119, etc, with a rather lengthy explanation of why.\n\nMy question is what it should represent.",
      "parentUuid": "dea9e6aa_1136577e",
      "revId": "6a4ea8db9f4595ce1373677ad8d3d43c7d9f21c9",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "82b94545_3dd8e51d",
        "filename": "build-data/packages/vpp.mk",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 361
      },
      "writtenOn": "2025-01-08T14:35:16Z",
      "side": 1,
      "message": "Good point, I think we should set it to MAX_WORKERS+8.\nNow, looking at this specific thing again, we basically want to enforce a default value of at least 1 element per thread + some margin (8 here) to avoid deadlock when multiple threads try to handover frames between them.\nMaybe instead we should always do something like this in vlib_frame_queue_main_init():\n  n_threads \u003d vlib_get_n_threads();\n  if (frame_queue_nelts \u003c n_threads + 8)\n  {\n    vlib_log_warn(\"frame_queue_elts raised from %d to %d\", frame_queue_elts, n_threads + 8);\n    frame_queue_elts \u003d n_threads + 8;\n  }\nIn that case we no longer have a need for hardcoded values?",
      "parentUuid": "b17b8e22_62e5b07c",
      "revId": "6a4ea8db9f4595ce1373677ad8d3d43c7d9f21c9",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f0a019a6_5b9309c7",
        "filename": "build-data/packages/vpp.mk",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 3171
      },
      "writtenOn": "2025-01-08T14:38:14Z",
      "side": 1,
      "message": "Btw, what is the reason why MAX_NELTS must be a power of 2?",
      "parentUuid": "82b94545_3dd8e51d",
      "revId": "6a4ea8db9f4595ce1373677ad8d3d43c7d9f21c9",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63f060c9_9720aea1",
        "filename": "build-data/packages/vpp.mk",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 3171
      },
      "writtenOn": "2025-01-08T23:55:32Z",
      "side": 1,
      "message": "About raising frame_queue_nelts - I see few problems with that:\nframe_queue_trace_t.n_vecotrs and frame_queue_nelt_counter_t.count are right now statically allocated for FRAME_QUEUE_MAX_NELTS.\n\nDoing that would require making malloc those fields.\n\nThat shouldn\u0027t be too hard to do, there is already vlib_frame_queue_alloc that seems to be a good place for that, but my previous question stands - why nelts must be a power of 2? With all the code around it seems to me that it actually should be dividable by aligned by CLIB_CACHE_LINE_BYTES.",
      "parentUuid": "f0a019a6_5b9309c7",
      "revId": "6a4ea8db9f4595ce1373677ad8d3d43c7d9f21c9",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "200e6abf_f10aa483",
        "filename": "build-data/packages/vpp.mk",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 3171
      },
      "writtenOn": "2025-01-19T00:04:40Z",
      "side": 1,
      "message": "I think getting rid of FRAME_QUEUE_MAX_NELTS is way harder than my current approach, so I\u0027d rather get a separate change around that and discuss all my concerns there.\n\nSo as initial questions were answered, I\u0027ll mark this thread as resolved.",
      "parentUuid": "63f060c9_9720aea1",
      "revId": "6a4ea8db9f4595ce1373677ad8d3d43c7d9f21c9",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    }
  ]
}
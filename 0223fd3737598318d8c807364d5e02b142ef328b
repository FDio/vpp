{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "8b1fea07_0f02cb78",
        "filename": "src/vnet/ipsec/esp_encrypt.c",
        "patchSetId": 8
      },
      "lineNbr": 233,
      "author": {
        "id": 267
      },
      "writtenOn": "2023-02-15T21:46:08Z",
      "side": 1,
      "message": "does it need to be per-SA or can it be per-worker? It\u0027s a random sequence either way, but per-thread is less memory.",
      "revId": "0223fd3737598318d8c807364d5e02b142ef328b",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a756b3ab_b2ce6357",
        "filename": "src/vnet/ipsec/esp_encrypt.c",
        "patchSetId": 8
      },
      "lineNbr": 233,
      "author": {
        "id": 361
      },
      "writtenOn": "2023-02-16T14:45:05Z",
      "side": 1,
      "message": "I thought about that, but I think it could become a security issue: in CBC, the IV must be unpredictable. For that, we encrypt the IV generated by the PRNG with the SA key.\nNow, if an attacker controls one tunnel, it can successfully decrypt the IVs (it knows the key for this specific SA) and from that partially recover the PRNG sequence for the thread. Because it is a PRNG, this is sufficient to recover the PRNG state and predict the entire PRNG sequence: IOW, the IV sequence for all tunnels sharing the same thread.\nFor counter modes (CTR or GCM), the IV should never been reused for the same key. If each SA has its own PRNG with a 2^64 period (ie the PRNG will not produced the same output twice over 2^64) we\u0027re good: the SN will wrap before the PRNG, and we\u0027ll have to rekey. If all SA of a thread share the PRNG, you\u0027ll have to reseed the PRNG at some point.\nI think it\u0027s just easier/safer to not share the PRNG.",
      "parentUuid": "8b1fea07_0f02cb78",
      "revId": "0223fd3737598318d8c807364d5e02b142ef328b",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3c3c2df3_ebaf7d25",
        "filename": "src/vnet/ipsec/esp_encrypt.c",
        "patchSetId": 8
      },
      "lineNbr": 233,
      "author": {
        "id": 361
      },
      "writtenOn": "2023-02-17T09:47:20Z",
      "side": 1,
      "message": "Thinking about it again, I think I\u0027m wrong concerning CBC: we do not care if someone discover the PRNG state as it\u0027s then encrypted with the SA key (that\u0027s the whole point :))\nHowever, I think my point still stands for counter mode: without having per SA state, it is hard to enforce that no same IV is generated twice for a given SA.",
      "parentUuid": "a756b3ab_b2ce6357",
      "revId": "0223fd3737598318d8c807364d5e02b142ef328b",
      "serverId": "6d2eb258-4fe2-443e-8a38-ca81da23d4c2"
    }
  ]
}